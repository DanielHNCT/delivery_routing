📋 REPORTE COMPLETO DEL FLUJO DE REQUESTS - APP COLIS PRIVÉ
================================================================

Basado en el análisis del archivo mas_log.log, he identificado el flujo completo 
de requests que realiza la aplicación móvil CP DISTRI V2 de Colis Privé.

🔍 INFORMACIÓN GENERAL DE LA APP
================================
- Nombre: CP DISTRI V2
- Package: com.danem.cpdistriv2
- Versión: 3.3.0.9 (actualizada desde 2.3.0.8)
- Dispositivo: Sony D5503 (Android 5.1.1)
- Usuario: A187518
- Sociedad: PCP0010699
- IMEI: 351680067703516

🚀 FLUJO COMPLETO DE REQUESTS
==============================

1. INICIALIZACIÓN Y CONFIGURACIÓN (21:45:00 - 21:45:45)
========================================================

1.1 Firebase Setup
------------------
POST https://firebaseinstallations.googleapis.com/v1/projects/pdacolisnotification-prod/installations
- Configuración de notificaciones push
- Obtiene FID y refresh token

1.2 Logging y Auditoría
------------------------
POST https://wslog.colisprive.com/WS_Commun/ServiceWCFLogSpir.svc/REST/LogMobilite
- Registra actividad de la app
- ActivityId: 2f5b63c4-80bd-431b-b5aa-8a0d0944435a

1.3 Referencial de Clientes
----------------------------
GET https://wsreferentiel-v2.colisprive.com/WS_RefDistributeur/RefDistributeurConsolideExtranetToExterne.svc/REST/ClientExtranetlightByTypeClient?TypeClient=PRESTATAIRECOLIS
- Obtiene lista de clientes prestataires

1.4 Servicios de Google
------------------------
- POST https://in.appcenter.ms/logs (AppCenter analytics)
- GET https://app-measurement.com/config (Google Analytics)
- POST https://play.googleapis.com/log (Google Play Services)
- POST https://cloudconfig.googleapis.com/config (Google Cloud Config)

1.5 Servicios Sony
------------------
- PUT https://api-x.sonymobile.com/myxperia/cc/devices/ (MyXperia)
- POST https://api-x.sonymobile.com/oauthv2/accesstoken (OAuth Sony)

2. AUTENTICACIÓN PRINCIPAL (21:45:46)
======================================

2.1 Login Inicial
-----------------
POST https://wsauthentificationexterne.colisprive.com/api/auth/login/Membership

Headers:
- ActivityId: 2f5b63c4-80bd-431b-b5aa-8a0d0944435a
- UserName: PCP0010699_A187518
- Societe: PCP0010699
- Domaine: Membership

Body:
{
  "audit": {
    "appName": "CP DISTRI V2",
    "deviceModelName": "Sony D5503",
    "iccid": "indisponible",
    "imei": "351680067703516",
    "msisdn": "indisponible",
    "noSerie": "3qtg83zdy95jmczkeiyx1rfa9"
  },
  "commun": {
    "dureeTokenInHour": 0
  },
  "login": "PCP0010699_A187518",
  "password": "INTI7518",
  "societe": "PCP0010699"
}

2.2 Auditoría de Instalación
-----------------------------
POST https://store.colisprive.com/WebApi/STORE/API/ANDROID/application/AuditDeviceInstall
POST https://store.colisprive.com/WebApi/STORE/API/android/application/AuditInstallResult/
- Registra la instalación y resultado

2.3 Verificación de Versión
---------------------------
GET https://store.hopps-group.com/WebApi/STORE/api/android/Application/com.danem.cpdistriv2/CheckVersionForUser/A187518/Version/2/3/0/8/...
GET https://store.colisprive.com/WebApi/STORE/api/android/Application/com.danem.cpdistriv2/CheckVersionForUser/A187518/Version/2/3/0/8/...
- Verifica si hay actualizaciones disponibles

2.4 Descarga de Actualización
-----------------------------
GET https://store.colisprive.com/WebApi/STORE/API/android/application/binary/4899
- Descarga la nueva versión 3.3.0.9

3. REFRESH TOKEN Y REAUTENTICACIÓN (21:46:24 - 21:46:26)
==========================================================

3.1 Logging con Nuevo ActivityId
--------------------------------
POST https://wslog.colisprive.com/WS_Commun/ServiceWCFLogSpir.svc/REST/LogMobilite
- Nuevo ActivityId: 523d2d46-defb-4aeb-b3fb-495e30106306

3.2 Referencial Actualizado
----------------------------
GET https://wsreferentiel-v2.colisprive.com/WS_RefDistributeur/RefDistributeurConsolideExtranetToExterne.svc/REST/ClientExtranetlightByTypeClient?TypeClient=PRESTATAIRECOLIS
- Obtiene datos actualizados con nueva versión

3.3 Refresh Token
-----------------
POST https://wsauthentificationexterne.colisprive.com/api/auth/login-token

Headers:
- ActivityId: 523d2d46-defb-4aeb-b3fb-495e30106306
- VersionApplication: 3.3.0.9

Body:
{
  "dureeTokenInHour": 0,
  "token": "Xal5G2w1CDR1AMe6uElQw4TCzBkHfIf8K3QICBMQLt5SvXDNPOsNCSzJM3MRIRVTcU3LW2PAIrLzqV8bOIlPQb/AK0y8p2C3pqx1L+UfqKr+xtaL+CLk5I+i+0+XDde8QFhmMfClgZk4KZiiF9GcvRNLoIS+EnN+Xkx4s/3CqDaGGjFKf/qCkOzgAa9LwXjFSSnE/WA/gcMYGuf/Bky+tIP71vYzB1mEori0pp0jdly/gFNcEbp1q8McH1cVAYYbHKlsWiek04ypLX06WstNY6AgcaMVg3Yr7E/zVgQz5bqTPB3gSyQeU/hLasyO3pFSpPMY764oHyxImR8iwghkVD1eToHoi8WfaoVjiDSd1+k="
}

3.4 Auditoría Post-Actualización
--------------------------------
POST https://store.colisprive.com/WebApi/STORE/API/ANDROID/application/AuditDeviceInstall
POST https://store.colisprive.com/WebApi/STORE/API/android/application/AuditInstallResult/
- Registra la nueva versión instalada

4. OBTENCIÓN DE TOURNÉE (21:46:28)
====================================

4.1 Request Principal de Tournée
--------------------------------
POST https://wstournee-v2.colisprive.com/WS-TourneeColis/api/getListTourneeMobileByMatriculeDistributeurDateDebut_POST

Headers:
- ActivityId: 523d2d46-defb-4aeb-b3fb-495e30106306
- AppName: CP DISTRI V2
- UserName: A187518
- AppIdentifier: com.danem.cpdistriv2
- Device: Sony D5503
- VersionOS: 5.1.1
- VersionApplication: 3.3.0.9
- VersionCode: 1
- Societe: PCP0010699
- Domaine: ""
- SsoHopps: [TOKEN_SSO_COMPLETO]

Body:
{
  "DateDebut": "2025-08-19",
  "Matricule": "PCP0010699_A187518"
}

4.2 Logging Post-Tournée
-------------------------
POST https://wslog.colisprive.com/WS_Commun/ServiceWCFLogSpir.svc/REST/LogMobilite
- Registra la obtención exitosa de tournée

5. SERVICIOS ADICIONALES (21:46:31 - 21:47:50)
===============================================

5.1 Servicio Danem
------------------
POST http://sd3.danem.fr/cpdistri/plutonservice.asmx
- SOAP request para servicio de distribución
- Login: PCP0010699_A187518;D5503
- IMEI: 351680067703516

5.2 GPS Assistance
------------------
GET http://xtra2.gpsonextra.net/xtra2.bin
- Datos de asistencia GPS

🔑 HEADERS CLAVE IDENTIFICADOS
==============================

Headers de Autenticación:
- ActivityId: Identificador único de sesión
- AppName: "CP DISTRI V2"
- UserName: Usuario autenticado
- Societe: Código de sociedad
- SsoHopps: Token SSO principal
- Device: Modelo del dispositivo
- VersionApplication: Versión de la app

Headers de Auditoría:
- AppIdentifier: Package de la app
- VersionOS: Versión de Android
- VersionCode: Código de versión interno

📱 PATRONES DE ACTUALIZACIÓN
============================

1. Verificación de Versión: La app verifica si hay actualizaciones disponibles
2. Descarga Automática: Si hay una nueva versión, la descarga automáticamente
3. Reinicio de Sesión: Después de la actualización, se reinicia la sesión con nuevo ActivityId
4. Refresh Token: Se obtiene un nuevo token SSO para continuar operaciones

🎯 ENDPOINTS PRINCIPALES
========================

- Autenticación: wsauthentificationexterne.colisprive.com
- Tournée: wstournee-v2.colisprive.com
- Logging: wslog.colisprive.com
- Referencial: wsreferentiel-v2.colisprive.com
- Store: store.colisprive.com

💡 OBSERVACIONES IMPORTANTES
============================

1. Seguridad: La app usa tokens SSO complejos y ActivityId únicos por sesión
2. Auditoría: Cada acción se registra con logging detallado
3. Actualizaciones: Sistema automático de actualización con reinicio de sesión
4. Compatibilidad: Soporte para Android 5.1.1 (versión antigua)
5. Integración: Múltiples servicios integrados (Google, Sony, Danem)

================================================================
Este flujo representa el comportamiento completo de la aplicación 
móvil oficial de Colis Privé, incluyendo autenticación, 
actualizaciones automáticas, y obtención de datos de tournée.

Fecha de análisis: 2025-08-19
Archivo analizado: mas_log.log
================================================================
